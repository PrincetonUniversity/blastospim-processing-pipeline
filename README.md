# BLASTOSPIM Instance Segmentation and Tracking Pipeline

## Step 1: Segmentation of Images

### Install the Pipeline

You can run the following commands to install the tool in your own machine.

#### Windows Install

1. Download and install **Python 3.11** version of Miniconda: https://docs.conda.io/en/latest/miniconda.html#windows-installers

2. Open "Command Prompt" and create a conda environment and activate it:
```
CONDA_OVERRIDE_CUDA="11.2" conda create -n tf2-segmentation "tensorflow==2.11.1=cuda112*" --channel conda-forge
conda activate tf2-segmentation
pip install stardist_inference @ git+https://github.com/abiswas-odu/stardist_inference.git
```

### Download and Run Example

#### Download example

To download the example execute the following commands:

```commandline
conda activate tf2-segmentation
pip install blastospim_download @ git+https://github.com/abiswas-odu/blastospim_download.git
cd blastospim_download
mkdir test
cd test 
blastospim_download
```

The commands will create a test directory and download 3 compressed folders and uncompress them in the current folder. The folders are:

1. data : The data files with the following folders:
    - Images : The original images from the microscope in TIF format. The images capture the transition from 8-16 cell stage division. 
    - Expected_Segmentation : The segmentation output that should be produced using the early stage model. 
    - Corrected_Segmentation : The expert corrected segmentation produced using AnnotatorJ.
    - Expected_Track : The config.yaml file and the expected registration transforms and tree.
2. early_embryo_model: The early model to be used for inference if the images have less than 45-50 cells.  
3. late_embryo_model: The late model to be used for inference if the images have greater than 45-50 cells.

##### Run the instance segmentation 

stardist_inference package has a reasonable commandline interface with help. 

```stardist_inference --help```

A sample SLURM script is provided in ```scripts/runInferenceSD.cmd```. Change the parameters on top and use ```sbatch``` to submit.
It may be necessary to load the anaconda/miniconda module if your login does not load it to begin with.

The TIF files produced should be compared with the TIF files in `Expected_Segmentation` for verification.

## Step 2: Manual Correction of Labels

The manual correction of labels is performed using a ImageJ plugin tool AnnotatorJ version 1.6. 

#### Create a Correction Directory

Create a directory with the original images and the `stardist_rois` directory in it. 
For the test example, copy the `stardist_rois` generated during Step 1 into the `Images` folder.

#### Install AnnotatorJ 1.6.2 

1. Install JRE version 8 from here: 
2. Download the AnnotatorJ 1.6.2 JAR file from here: https://drive.google.com/file/d/1Tnsy-BcGLwSHmU4rwH-4taSEwHA1RqoF/view?usp=drive_link
3. Change to the directory with the AnnotatorJ 1.6 JAR file and execute the command:
```commandline
java -jar annotator_Project-1.6.2.jar
```
4. This should open the following 2 windows


![Opening AnnotatorJ 1.6](./doc_images/annotatorj_1.jpg "AnnotatorJ 1.6.2")

#### Performing Manual Corrections

1. Click the Open button in the AnnotatorJ 1.6.2 window and navigate to the `Images` folder. 

2. Select the image to be corrected. After the image is loaded, scroll to the frame to be corrected. 


![Editing with AnnotatorJ 1.6](./doc_images/annotatorj_2.jpg "Editing with AnnotatorJ 1.6")

3. The boundary of the segmentation of the cells is shows in different colors. These boundaries are called Region on Interest or *ROI* .
The `ROI Manager` window shows the label IDs and the frame number of each cell. 
The same cell is colored the same across the frames of the 3D image. 

4. ROIs can be selected in the `ROI Manager` window and edited. The selected ROI color changes to cyan as seen below.


![Selecting ROI](./doc_images/annotatorj_3.jpg "Selecting ROI")

5. The `ROI Manager` window and the AnnoratorJ window provide various functions to add, 
rename, delete individual ROIs and whole cells. These can be used to correct any segmentation errors.


## Registration of Labels 

After the labels generated by the segmentation are corrected the images need to be registered as the embryos rotate randomly. 
The registration and the tracking scripts are written in MATLAB and require a `config.yaml` file to be created to drive the scripts. 

### Download the MATLAB Library

1. Download and install MATLAB.

2. Run the following commands to clone the repository:
```commandline
git clone 
```


## Tracking of Labels